#!/usr/bin/env tclsh

package require Tcl 8
package require fileutil 1.15

set serverName [lindex $::argv 0]
set bufferName [lindex $::argv 1]

set bufferSize 4096
set tempPath [::fileutil::tempfile]

proc spit {path content} {
    set fd [open $path w]
    puts -nonewline $fd $content
    close $fd
}

while {![eof stdin]} {
    set input [read stdin $bufferSize]
    puts -nonewline $input
    spit $tempPath $input
    exec rmacs --name $serverName eval "(with-current-buffer (get-buffer-create \"$bufferName\")
  (save-excursion
    (goto-char (point-max))
    (insert-file \"$tempPath\")))
  " 2>@ stderr
}

file delete $tempPath
